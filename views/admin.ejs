<!DOCTYPE html>
<html lang="en">
<%- include('partials/head') %>
  <body>
<%- include('partials/header') %>
    <div class="container">
      <h2><%= question %></h2>
      <p>Friends&rsquo; link: <a href="/polls/<%= publicPollKey %>">/polls/<%= publicPollKey %></a></p>
      <p>Your (private) link: <a href="/polls/admin/<%= privatePollKey %>">/polls/admin/<%= privatePollKey %></a></p>

      <% let totalPoints = 0; %>
      <% choices.sort((a, b) => { %>
        <% return b.points - a.points; %>
      <% }); %>

      <% let numWinners = 0; %>
      <% choices.forEach((choice, index) => { %>
        <% choice.rank = index + 1; %>
        <% if (index > 0 && choice.points === choices[index-1].points) { %>
          <% choice.rank = choices[index-1].rank; %>
        <% } %>
        <% let winner = choice.points > 0 && choice.points === choices[0].points; %>
        <% totalPoints += choice.points; %>
        <% if (winner) numWinners++; %>
        <% choice.winner = winner; %>
      <% }); %>

      <div class="section-container">
        <h3>Results</h3>
      <% if (numWinners === 1) { %>
        <p class="lead">We have a winner!</p>
      <% } else if (numWinners > 1) { %>
        <p class="lead">It&rsquo;s all tied up!</p>
      <% } else { %>
        <p class="lead">No votes yet. Support democracy by <a href="#sendSMS">sending the poll</a> to your friends.</p>
      <% } %>
      <% choices.forEach((choice, index) => { %>
        <% choice.tied = choice.numWinners > 1; %>
        <% choice.totalPoints = totalPoints; %>
        <%- include('partials/pollresult', choice); %>
      <% }); %>
      </div><!-- /.results-container -->

      <%# If the poll is open, show the forms for sending the poll. %>
      <% if (is_open) { %>
      <div class="section-container">
        <h3>Send the poll</h3>
        <div class="row">
          <div class="col-sm-6">
            <div class="well">
              <h4>Message the poll to your friends!</h4>
              <form id="sendSMS" action="/sms/sendpoll" method="post">
                <div class="form-group">
                  <label for="phone-number">Phone number</label>
                  <input type="number" class="form-control" id="phone-number" name="phone-number" placeholder="6041234559" aria-describedby="phone-number-help" max="9999999999">
                  <span id="phone-number-help" class="help-block">Enter a phone number (no spaces or dashes) and we&rsquo;ll send the poll in an sms message.</span>
                  <input type="hidden" name="private_key" value="<%= privatePollKey %>">
                </div>
                <button type="submit" class="btn btn-default">Submit</button>
              </form>
            </div><!-- /.well -->
          </div>
          <div class="col-sm-6">
            <div class="well">
              <h4>Email the poll to your friends!</h4>
              <form id="sendEmail" action="#" method="post">
                <div class="form-group">
                  <label for="email">Email</label>
                  <input type="email" class="form-control" id="email" name="email" placeholder="friend@example.com" aria-describedby="email-help">
                  <span id="email-help" class="help-block">Enter an email and we&rsquo;ll send the poll.</span>
                  <input type="hidden" name="private_key" value="<%= privatePollKey %>">
                </div>
                <button type="submit" class="btn btn-default">Submit</button>
              </form>
            </div><!-- /.well -->
          </div>
        </div><!-- /.row -->

        <p>All the results in?</p>
        <button class="btn btn-default">Close poll</button>
      </div><!-- /.dashboard-container -->
      <% } else { %>
      <p>Want more feedback?</p>
      <button class="btn btn-default">Open poll</button>
      <% } %>
    </div><!-- /.container -->
    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
  </body>
</html>
